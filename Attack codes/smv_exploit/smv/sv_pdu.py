from pyasn1.type.univ import OctetString, Integer, Sequence, SequenceOf
from pyasn1.type.namedtype import NamedTypes, NamedType
from pyasn1.type.tag import Tag, tagClassContext, tagFormatConstructed, tagFormatSimple
from pyasn1.type import char, tag, univ, namedtype, constraint



class UtcTime(univ.OctetString):
    # subtypeSpec = constraint.ValueSizeConstraint(8, 8)
    pass

class Data(univ.OctetString):
    pass


# ASN.1 structure for ASDU
class ASDU(univ.Sequence):
    componentType = NamedTypes(
        NamedType('svID', 
                  char.VisibleString().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          0 #0x80
                        )
                    )
                ),
        # NamedType('datSet',
        #           char.VisibleString().subtype(
        #               implicitTag=Tag(
        #                   tag.tagClassContext,
        #                   tag.tagFormatSimple,
        #                   1 # 0x81
        #                 )
        #           )
        #         ),
        
        NamedType('smpCnt', 
                  univ.Integer().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          2 # 0x82 
                        )
                    )
                ),
        
        NamedType('confRev', 
                  univ.Integer().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          3 # 0x83 
                        )
                    )
                ),
        
        # NamedType('refrTm',
        #           UtcTime().subtype(
        #                 implicitTag=Tag(
        #                     tag.tagClassContext, 
        #                     tag.tagFormatSimple, 
        #                     4 # 0x84 
        #                     )
        #                 )
        #           ),
        
        NamedType('smpSynch', 
                  univ.Integer().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          5 #0x85 
                        )
                    )
                ),
        
        # NamedType('smpRate',
        #           univ.Integer().subtype(
        #               implicitTag=Tag(
        #                   tag.tagClassContext, 
        #                   tag.tagFormatSimple, 
        #                   6 # 0x86 
        #                 )
        #             )
        #         ),
        
        NamedType('seqData', 
                  Data().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          7 # 0x87 
                        )
                    )
                )
    )

# ASN.1 structure for SeqASDU
class SeqASDU(univ.SequenceOf):
    componentType = ASDU()
   

class SavPDU(univ.Sequence):
    componentType = NamedTypes(
        NamedType('noASDU', 
                  univ.Integer().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          0 # 0x80
                        )
                    )
                ),
        NamedType('seqASDU', 
                  SeqASDU().subtype(
                      implicitTag=Tag(
                          tag.tagClassContext, 
                          tag.tagFormatSimple, 
                          2 # 0xa2
                        )
                    )
                )
    )



if __name__ == "__main__":
    
    # sav = SavPDU().subtype(
    #     implicitTag = Tag(
    #         tag.tagClassContext,
    #         tag.tagFormatConstructed,
    #         2
    #     )
    # )

    
    # asdu = ASDU().subtype(
    #     implicitTag = Tag(
    #         tag.tagClassContext,
    #         tag.tagFormatConstructed,
    #         1
    #     )
    # )
    
    asdu = ASDU()
    
    asdu.setComponentByName('svID', '4001')
    asdu.setComponentByName('datSet', 'SV1')
    asdu.setComponentByName('smpCnt', 280)
    asdu.setComponentByName('confRev', 1)
    asdu.setComponentByName('refrTm',  b'\x55\x15\x1b\x9b\x69\x37\x40\x92')
    asdu.setComponentByName('smpSynch', 0)  
    asdu.setComponentByName('smpRate', 1)
    asdu.setComponentByName('seqData', b"\xff\xfe\x59\x82\x00\x00\x00\x00\x00")
    
    
    print(asdu.prettyPrint())
    
    
    # seq = SeqASDU().subtype(
    #     implicitTag = Tag(
    #         tag.tagClassContext,
    #         tag.tagFormatConstructed,
    #         1
    #     )
    # )
    seq = SeqASDU()
    
    
    seq.setComponentByPosition(0, asdu)  # Indexing starts from 0
    seq.setComponentByPosition(1, asdu)  # Indexing starts from 0
    print(seq.prettyPrint())
    
    sav = SavPDU()
    
    # sav.setComponentByName('noASDU', 1)
    sav.setComponentByPosition(0, 1)
    # sav.setComponentByName('seqASDU', seq)
    sav.setComponentByPosition(1, seq)
    
    print(sav.prettyPrint())
    